// ==UserScript==
// @name         MangaGo Image Downloader (CORS Fix)
// @namespace    http://tampermonkey.net/
// @version      2.2
// @description  Download images from MangaGo - CORS Fixed
// @author       You
// @match        https://www.mangago.me/read-manga/*
// @match        https://www.mangago.me/r/*
// @grant        GM_xmlhttpRequest
// @connect      pic1.mangapicgallery.com
// @connect      *
// ==/UserScript==

(function() {
    'use strict';

    // GM_xmlhttpRequest wrapper to bypass CORS
    function fetchWithGM(url) {
        return new Promise((resolve, reject) => {
            if (typeof GM_xmlhttpRequest === 'undefined') {
                // Fallback to regular fetch if GM not available
                fetch(url)
                    .then(response => response.text())
                    .then(text => resolve(text))
                    .catch(reject);
                return;
            }

            GM_xmlhttpRequest({
                method: 'GET',
                url: url,
                onload: function(response) {
                    resolve(response.responseText);
                },
                onerror: function(error) {
                    reject(error);
                }
            });
        });
    }

    // Load CryptoJS
    const loadCryptoJS = () => {
        return new Promise((resolve, reject) => {
            if (typeof CryptoJS !== 'undefined') {
                console.log('CryptoJS already loaded');
                resolve();
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
            script.onload = () => resolve();
            script.onerror = () => reject(new Error('Failed to load CryptoJS'));
            document.head.appendChild(script);
        });
    };

    let isProcessing = false;

    // Deobfuscate sojson.v4 obfuscated script
    function soJsonV4Deobfuscator(obfuscatedJs) {
        if (!obfuscatedJs.includes("['sojson.v4']")) return obfuscatedJs;

        try {
            const s = obfuscatedJs.substring(240, obfuscatedJs.length - 60);
            let result = '';
            const matches = s.match(/\d+/g);
            if (matches) {
                for (const charCode of matches) {
                    result += String.fromCharCode(parseInt(charCode));
                }
            }
            return result;
        } catch (e) {
            console.error('Deobfuscation error:', e);
            return obfuscatedJs;
        }
    }

    // Unscramble the decrypted image list string
    function unscrambleImageList(imageListStr, deobfuscatedJs) {
        try {
            const keyLocations = [];
            const regex = /str\.charAt\s*\(\s*(\d+)\s*\)/g;
            let match;
            while ((match = regex.exec(deobfuscatedJs)) !== null) {
                keyLocations.push(parseInt(match[1]));
            }

            const uniqueLocations = [...new Set(keyLocations)];
            if (uniqueLocations.length === 0) return imageListStr;

            const unscrambleKey = [];
            for (const loc of uniqueLocations) {
                const digit = parseInt(imageListStr.charAt(loc));
                if (isNaN(digit)) return imageListStr;
                unscrambleKey.push(digit);
            }

            const imgListArray = imageListStr.split('');
            const cleanedImgList = imgListArray.filter((_, i) => !uniqueLocations.includes(i)).join('');

            return stringUnscramble(cleanedImgList, unscrambleKey);
        } catch (e) {
            console.error('Unscramble error:', e);
            return imageListStr;
        }
    }

    // Reorder a scrambled string based on an embedded key
    function stringUnscramble(scrambledStr, keys) {
        const sArray = scrambledStr.split('');

        for (let j = keys.length - 1; j >= 0; j--) {
            const keyVal = keys[j];
            for (let i = sArray.length - 1; i > keyVal; i--) {
                if ((i - 1) % 2 !== 0) {
                    const idx1 = i - keyVal - 1;
                    const idx2 = i - 1;
                    [sArray[idx1], sArray[idx2]] = [sArray[idx2], sArray[idx1]];
                }
            }
        }

        return sArray.join('');
    }

    // Show debug log
    function showDebugLog(message, isError = false) {
        console.log(message);
        
        let logBox = document.getElementById('mangago-debug-log');
        if (!logBox) {
            logBox = document.createElement('div');
            logBox.id = 'mangago-debug-log';
            logBox.style.cssText = `
                position: fixed;
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-height: 200px;
                overflow-y: auto;
                background: rgba(0, 0, 0, 0.9);
                color: #0f0;
                font-family: monospace;
                font-size: 11px;
                padding: 10px;
                border-radius: 5px;
                z-index: 99999;
                white-space: pre-wrap;
                word-wrap: break-word;
            `;
            document.body.appendChild(logBox);
        }

        const timestamp = new Date().toLocaleTimeString();
        const color = isError ? '#f00' : '#0f0';
        const entry = document.createElement('div');
        entry.style.color = color;
        entry.textContent = `[${timestamp}] ${message}`;
        logBox.appendChild(entry);
        logBox.scrollTop = logBox.scrollHeight;
    }

    // Main download function
    async function downloadAllImages() {
        if (isProcessing) {
            alert('Download already in progress!');
            return;
        }

        isProcessing = true;
        
        try {
            showDebugLog('=== Starting Download Process ===');
            
            // Load CryptoJS
            showDebugLog('Step 1: Loading CryptoJS...');
            await loadCryptoJS();
            showDebugLog('âœ“ CryptoJS loaded');

            // Find imgsrcs
            showDebugLog('Step 2: Finding encrypted data...');
            const scripts = document.querySelectorAll('script:not([src])');
            showDebugLog(`Found ${scripts.length} inline scripts`);
            
            let imgsrcMatch = null;
            for (let i = 0; i < scripts.length; i++) {
                const content = scripts[i].textContent;
                if (content.includes('imgsrcs')) {
                    showDebugLog(`Found imgsrcs in script ${i + 1}`);
                    imgsrcMatch = content.match(/var\s+imgsrcs\s*=\s*['"]([^'"]+)['"]/);
                    if (!imgsrcMatch) {
                        imgsrcMatch = content.match(/imgsrcs\s*=\s*['"]([^'"]+)['"]/);
                    }
                    if (imgsrcMatch) break;
                }
            }
            
            if (!imgsrcMatch) {
                showDebugLog('âœ— Cannot find imgsrcs variable', true);
                throw new Error('Cannot find encrypted image data');
            }

            const imgsrcB64 = imgsrcMatch[1];
            showDebugLog(`âœ“ Found encrypted data: ${imgsrcB64.length} chars`);

            // Find chapter.js
            showDebugLog('Step 3: Loading chapter.js...');
            const chapterJsUrl = document.querySelector('script[src*="chapter.js"]')?.src;
            if (!chapterJsUrl) {
                showDebugLog('âœ— Cannot find chapter.js', true);
                throw new Error('Cannot find chapter.js URL');
            }
            showDebugLog(`Found chapter.js: ${chapterJsUrl}`);
            
            // Use GM_xmlhttpRequest to bypass CORS
            showDebugLog('Fetching via GM_xmlhttpRequest...');
            const chapterJsText = await fetchWithGM(chapterJsUrl);
            showDebugLog(`âœ“ Loaded chapter.js: ${chapterJsText.length} chars`);
            
            // Deobfuscate
            showDebugLog('Step 4: Deobfuscating...');
            const deobfuscatedJs = soJsonV4Deobfuscator(chapterJsText);
            showDebugLog(`âœ“ Deobfuscated: ${deobfuscatedJs.length} chars`);

            // Find key and IV
            showDebugLog('Step 5: Finding decryption key...');
            const keyMatch = deobfuscatedJs.match(/var\s+key\s*=\s*CryptoJS\.enc\.Hex\.parse\s*\(\s*["']([0-9a-fA-F]+)["']\s*\)/);
            const ivMatch = deobfuscatedJs.match(/var\s+iv\s*=\s*CryptoJS\.enc\.Hex\.parse\s*\(\s*["']([0-9a-fA-F]+)["']\s*\)/);

            if (!keyMatch || !ivMatch) {
                showDebugLog('âœ— Cannot find key or IV', true);
                throw new Error('Cannot find decryption key or IV');
            }
            
            showDebugLog(`âœ“ Key: ${keyMatch[1].substring(0, 16)}...`);
            showDebugLog(`âœ“ IV: ${ivMatch[1].substring(0, 16)}...`);

            // Decrypt
            showDebugLog('Step 6: Decrypting data...');
            const key = CryptoJS.enc.Hex.parse(keyMatch[1]);
            const iv = CryptoJS.enc.Hex.parse(ivMatch[1]);

            const decrypted = CryptoJS.AES.decrypt(imgsrcB64, key, {
                iv: iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.ZeroPadding
            });

            const decryptedImageList = decrypted.toString(CryptoJS.enc.Utf8).replace(/\0+$/g, '');
            
            if (!decryptedImageList) {
                showDebugLog('âœ— Decryption returned empty string', true);
                throw new Error('Decryption failed');
            }
            
            showDebugLog(`âœ“ Decrypted: ${decryptedImageList.length} chars`);

            // Parse image URLs
            showDebugLog('Step 7: Parsing image URLs...');
            const finalImageList = unscrambleImageList(decryptedImageList, deobfuscatedJs);
            const imageUrls = finalImageList.split(',').filter(url => url.trim());
            showDebugLog(`âœ“ Found ${imageUrls.length} image URLs`);

            showDebugLog('=== SUCCESS ===');
            
            // Display URLs
            const urlList = imageUrls.join('\n');
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 999999;
                display: flex;
                flex-direction: column;
                padding: 20px;
                box-sizing: border-box;
            `;

            const title = document.createElement('div');
            title.style.cssText = `
                color: white;
                font-size: 20px;
                font-weight: bold;
                margin-bottom: 15px;
                text-align: center;
            `;
            title.textContent = `âœ… Found ${imageUrls.length} Images`;

            const instructions = document.createElement('div');
            instructions.style.cssText = `
                color: #4CAF50;
                font-size: 14px;
                margin-bottom: 10px;
                text-align: center;
            `;
            instructions.innerHTML = `
                Copy these URLs and use a download manager<br>
                Or right-click each image > Save As
            `;

            const urlBox = document.createElement('textarea');
            urlBox.style.cssText = `
                flex: 1;
                width: 100%;
                background: white;
                border: 3px solid #4CAF50;
                border-radius: 10px;
                padding: 15px;
                font-family: monospace;
                font-size: 12px;
                box-sizing: border-box;
                margin-bottom: 15px;
            `;
            urlBox.value = urlList;
            urlBox.readOnly = true;

            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 10px;
                justify-content: center;
            `;

            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'ðŸ“‹ Copy All URLs';
            copyBtn.style.cssText = `
                padding: 15px 30px;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 8px;
                font-weight: bold;
                font-size: 16px;
                cursor: pointer;
            `;
            copyBtn.onclick = () => {
                urlBox.select();
                document.execCommand('copy');
                copyBtn.textContent = 'âœ… Copied!';
                setTimeout(() => {
                    copyBtn.textContent = 'ðŸ“‹ Copy All URLs';
                }, 2000);
            };

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'âŒ Close';
            closeBtn.style.cssText = `
                padding: 15px 30px;
                background: #f44336;
                color: white;
                border: none;
                border-radius: 8px;
                font-weight: bold;
                font-size: 16px;
                cursor: pointer;
            `;
            closeBtn.onclick = () => overlay.remove();

            buttonContainer.appendChild(copyBtn);
            buttonContainer.appendChild(closeBtn);

            overlay.appendChild(title);
            overlay.appendChild(instructions);
            overlay.appendChild(urlBox);
            overlay.appendChild(buttonContainer);
            document.body.appendChild(overlay);

            urlBox.select();

        } catch (error) {
            showDebugLog('âœ—âœ—âœ— FATAL ERROR âœ—âœ—âœ—', true);
            showDebugLog('Error: ' + error.message, true);
            if (error.stack) {
                showDebugLog('Stack: ' + error.stack, true);
            }
            alert('Error: ' + error.message + '\n\nCheck the debug log at the bottom.');
        } finally {
            isProcessing = false;
        }
    }

    // Add download button
    function addDownloadButton() {
        if (!document.querySelector('script[src*="chapter.js"]')) {
            console.log('Not a chapter reading page');
            return;
        }

        const button = document.createElement('button');
        button.id = 'mangago-download-btn';
        button.textContent = 'ðŸ“¥ Get Image URLs';
        button.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            padding: 12px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        `;

        button.addEventListener('click', downloadAllImages);

        document.body.appendChild(button);
        console.log('Download button added');
    }

    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', addDownloadButton);
    } else {
        addDownloadButton();
    }

    console.log('MangaGo Downloader v2.2 (CORS Fixed) loaded');

})();
